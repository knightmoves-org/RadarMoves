@page "/"
@rendermode InteractiveWebAssembly
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.SignalR.Client
@using RadarMoves.Client.Services
@using RadarMoves.Shared.Services
@using RadarMoves.Shared.Data
@inject IServiceProvider ServiceProvider
@inject NavigationManager NavigationManager
@inject ILogger<RadarViewer> Logger
@inject ImageCacheService ImageCache
@inject RadarControlsService ControlsService
@implements IAsyncDisposable
@implements IDisposable

<PageTitle>Radar Viewer</PageTitle>

<div class="radar-viewer-container">
    <div class="viewer-main">
        <div class="status-bar">
            @if (IsLoading)
            {
                <span>Loading...</span>
            }
            else if (ControlsService.Timestamps.Count > 0)
            {
                <span>Loaded @ControlsService.Timestamps.Count time points - View: @ControlsService.SelectedViewType</span>
            }
            else
            {
                <span>No data available</span>
            }
        </div>
        <div class="image-container">
            @if (ImageUrl != null)
            {
                <img src="@ImageUrl" alt="Radar Image" class="radar-image" />
            }
            else if (IsLoading)
            {
                <div class="loading-message">Loading image...</div>
            }
            else
            {
                <div class="canvas-placeholder">
                    <p>Radar visualization will appear here</p>
                    <p class="hint">Use the controls to navigate through the data</p>
                </div>
            }
        </div>

        <!-- Value Display (only for Radar view) -->
        @if (ControlsService.SelectedViewType == "Radar" && CurrentValue.HasValue)
        {
            <div class="value-display-panel">
                <strong>Value at (@ControlsService.Latitude.ToString("F4")°,
                    @ControlsService.Longitude.ToString("F4")°):</strong>
                <span class="value-text">@CurrentValue.Value.ToString("F2")</span>
            </div>
        }
    </div>
</div>

@code {
    private float? CurrentValue { get; set; }
    private PolarScanMetadata? ScanMetadata { get; set; }

    private bool IsLoading { get; set; } = true;
    private string? ErrorMessage { get; set; }
    private HttpClient? Http { get; set; }
    private string? ImageUrl { get; set; }

    // SignalR Hub Connection (only for Radar view)
    private HubConnection? _hubConnection;
    private bool _isDisposed = false;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to controls service changes
        ControlsService.OnStateChanged += OnControlsChanged;

        // Get HttpClient from service provider (works for both server and client rendering)
        Http = ServiceProvider.GetService<HttpClient>();
        if (Http == null)
        {
            // Fallback: create HttpClient if not available
            // Use the current page's base address
            var baseAddress = NavigationManager.BaseUri;
            Http = new HttpClient { BaseAddress = new Uri(baseAddress) };
        }

        // Initialize SignalR hub connection only for Radar view
        if (ControlsService.SelectedViewType == "Radar")
        {
            _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/radarDataHub"))
            .Build();

            // Register event handlers
            RegisterEventHandlers();

            // Handle connection lifecycle
            _hubConnection.Closed += async (error) =>
            {
                if (_isDisposed) return;
                Logger.LogWarning("Hub connection closed: {Error}", error?.Message);
                await Task.Delay(2000);
                if (!_isDisposed && _hubConnection != null)
                {
                    await StartConnection();
                }
            };

            _hubConnection.Reconnecting += (error) =>
            {
                Logger.LogInformation("Hub reconnecting: {Error}", error?.Message);
                return Task.CompletedTask;
            };

            _hubConnection.Reconnected += (connectionId) =>
            {
                Logger.LogInformation("Hub reconnected: {ConnectionId}", connectionId);
                return Task.CompletedTask;
            };

            // Start hub connection and load initial data
            await StartConnection();
            await LoadProcessedTimestamps();
        }
        else
        {
            // For Raw Data and Filtered Data, use regular API
            await LoadMetadata();
        }

        if (ControlsService.Timestamps.Count > 0)
        {
            // Default to first timestamp
            ControlsService.TimeIndex = 0;
            await LoadElevations();
            if (ControlsService.ElevationAngles.Count > 0)
            {
                // Default to first elevation
                ControlsService.ElevationIndex = 0;
                await LoadScanMetadata();
                if (ControlsService.SelectedViewType == "Radar")
                {
                    await LoadValue();
                }
                await LoadImage();
            }
        }

        IsLoading = false;
    }

    private async void OnControlsChanged()
    {
        // If view type changed, reinitialize SignalR if needed
        if (ControlsService.SelectedViewType == "Radar" && _hubConnection == null)
        {
            _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/radarDataHub"))
            .Build();
            RegisterEventHandlers();
            await StartConnection();
            await LoadProcessedTimestamps();
        }
        else if (ControlsService.SelectedViewType != "Radar" && _hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
            _hubConnection = null;
        }

        await OnTimeChanged();
        await InvokeAsync(StateHasChanged);
    }

    private void RegisterEventHandlers()
    {
        if (_hubConnection == null) return;

        // PVOLProcessed event - update timestamps when new PVOL is processed
        _hubConnection.On<DateTime, float[]>("PVOLProcessed", async (timestamp, elevations) =>
        {
            Logger.LogInformation("PVOL processed: {Timestamp} with {Count} elevations", timestamp, elevations.Length);

            // Add new timestamp if not already present
            var timestampString = timestamp.ToString("yyyy-MM-ddTHH:mm:ss");
            var wasEmpty = ControlsService.Timestamps.Count == 0;
            var currentTimestamp = ControlsService.TimeIndex < ControlsService.Timestamps.Count ?
    ControlsService.Timestamps[ControlsService.TimeIndex] : null;

            if (!ControlsService.Timestamps.Contains(timestampString))
            {
                ControlsService.Timestamps.Add(timestampString);
                ControlsService.Timestamps.Sort(); // Keep timestamps sorted

                // Update time range
                if (ControlsService.Timestamps.Count > 0)
                {
                    var first = DateTime.Parse(ControlsService.Timestamps.First());
                    var last = DateTime.Parse(ControlsService.Timestamps.Last());
                    ControlsService.TimeRange = (first, last);
                }

                // If this is the first timestamp, select it and load data
                if (wasEmpty)
                {
                    ControlsService.TimeIndex = ControlsService.Timestamps.IndexOf(timestampString);
                    await LoadElevations();
                    if (ControlsService.ElevationAngles.Count > 0)
                    {
                        ControlsService.ElevationIndex = 0;
                        await LoadScanMetadata();
                        await LoadValue();
                        await LoadImage();
                    }
                }

                ControlsService.NotifyStateChanged();
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                // Timestamp already exists, but elevations might have changed
                // If we're currently viewing this timestamp, reload elevations and image
                if (currentTimestamp == timestampString)
                {
                    await LoadElevations();
                    await LoadScanMetadata();
                    await LoadValue();
                    await LoadImage();
                    await InvokeAsync(StateHasChanged);
                }
            }
        });
    }

    private async Task StartConnection()
    {
        if (_isDisposed || _hubConnection == null) return;

        if (_hubConnection.State == HubConnectionState.Disconnected)
        {
            try
            {
                await _hubConnection.StartAsync();
                if (!_isDisposed && _hubConnection != null)
                {
                    await _hubConnection.SendAsync("SubscribeToPVOLUpdates");
                    Logger.LogInformation("Connected to RadarDataHub and subscribed to PVOL updates");
                }
            }
            catch (ObjectDisposedException)
            {
                // Connection was disposed, ignore
                Logger.LogDebug("Hub connection was disposed during start");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error starting hub connection");
                ErrorMessage = $"Connection error: {ex.Message}";
            }
        }
    }

    private async Task LoadProcessedTimestamps()
    {
        if (_hubConnection?.State != HubConnectionState.Connected)
        {
            Logger.LogWarning("Hub not connected, cannot load processed timestamps");
            return;
        }

        try
        {
            IsLoading = true;
            var pvolTimestamps = await _hubConnection.InvokeAsync<IEnumerable<DateTime>>("GetAvailablePVOLs");

            // Convert to string list and sort
            ControlsService.Timestamps = pvolTimestamps
            .Select(t => t.ToString("yyyy-MM-ddTHH:mm:ss"))
            .OrderBy(t => t)
            .ToList();

            // Update time range if we have timestamps
            if (ControlsService.Timestamps.Count > 0)
            {
                var first = DateTime.Parse(ControlsService.Timestamps.First());
                var last = DateTime.Parse(ControlsService.Timestamps.Last());
                ControlsService.TimeRange = (first, last);
            }

            Logger.LogInformation("Loaded {Count} processed PVOL timestamps", ControlsService.Timestamps.Count);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading processed timestamps: {ex.Message}";
            Logger.LogError(ex, "Error loading processed timestamps");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadMetadata()
    {
        if (Http == null) return;
        try
        {
            IsLoading = true;
            var response = await Http.GetFromJsonAsync<MetadataResponse>("api/RadarData/metadata");
            if (response != null && response.TimeRange != null)
            {
                ControlsService.TimeRange = (response.TimeRange.Start, response.TimeRange.End);
            }

            var timestamps = await Http.GetFromJsonAsync<List<string>>("api/RadarData/timestamps");
            if (timestamps != null)
            {
                ControlsService.Timestamps = timestamps;
                if (ControlsService.Timestamps.Count > 0 && ControlsService.TimeIndex >= ControlsService.Timestamps.Count)
                {
                    ControlsService.TimeIndex = 0;
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading metadata: {ex.Message}";
            Logger.LogError(ex, "Error loading metadata");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadElevations()
    {
        if (Http == null) return;
        try
        {
            if (ControlsService.Timestamps.Count == 0) return;

            var timestamp = ControlsService.Timestamps[ControlsService.TimeIndex];

            // For Radar view, try SignalR first
            if (ControlsService.SelectedViewType == "Radar" && _hubConnection != null)
            {
                if (!DateTime.TryParse(timestamp, out var dt))
                {
                    Logger.LogWarning("Invalid timestamp format: {Timestamp}", timestamp);
                    return;
                }

                // Try to get elevations from hub (processed PVOL metadata)
                if (_hubConnection.State == HubConnectionState.Connected)
                {
                    try
                    {
                        var metadata = await _hubConnection.InvokeAsync<object?>("GetPVOLMetadata", dt);
                        if (metadata != null)
                        {
                            // Parse the metadata to get elevations
                            var metadataJson = System.Text.Json.JsonSerializer.Serialize(metadata);
                            var doc = System.Text.Json.JsonDocument.Parse(metadataJson);
                            if (doc.RootElement.TryGetProperty("elevations", out var elevationsElement))
                            {
                                var elevations = elevationsElement.EnumerateArray()
                                .Select(e => e.GetSingle())
                                .OrderBy(e => e)
                                .ToList();

                                if (elevations.Count > 0)
                                {
                                    ControlsService.ElevationAngles = elevations;
                                    // Ensure ElevationIndex is valid
                                    if (ControlsService.ElevationIndex >= ControlsService.ElevationAngles.Count)
                                    {
                                        ControlsService.ElevationIndex = 0;
                                    }
                                    return;
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Logger.LogDebug("Could not get elevations from hub, falling back to API: {Error}", ex.Message);
                    }
                }
            }

            // Fallback to API endpoint if hub doesn't have the data or not using Radar view
            var apiElevations = await
            Http.GetFromJsonAsync<List<float>>($"api/RadarData/elevations/{Uri.EscapeDataString(timestamp)}");
            if (apiElevations != null)
            {
                ControlsService.ElevationAngles = apiElevations.OrderBy(e => e).ToList();
                // ElevationIndex is already set to 0 by default, but ensure it's valid
                if (ControlsService.ElevationAngles.Count > 0 && ControlsService.ElevationIndex >=
                ControlsService.ElevationAngles.Count)
                {
                    ControlsService.ElevationIndex = 0;
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading elevations: {ex.Message}";
            Logger.LogError(ex, "Error loading elevations");
        }
    }

    private async Task LoadScanMetadata()
    {
        if (Http == null) return;
        try
        {
            if (ControlsService.Timestamps.Count == 0 || ControlsService.ElevationAngles.Count == 0) return;

            var timestamp = ControlsService.Timestamps[ControlsService.TimeIndex];
            var elevation = ControlsService.SelectedElevation;
            var response = await
            Http.GetFromJsonAsync<PolarScanMetadata>($"api/RadarData/scan/{Uri.EscapeDataString(timestamp)}/{elevation}");
            if (response != null)
            {
                ScanMetadata = response;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading scan metadata");
        }
    }

    private async Task LoadValue()
    {
        if (Http == null || ControlsService.SelectedViewType != "Radar") return;
        try
        {
            if (ControlsService.Timestamps.Count == 0 || ControlsService.ElevationAngles.Count == 0)
            {
                CurrentValue = null;
                return;
            }

            var timestamp = ControlsService.Timestamps[ControlsService.TimeIndex];
            var elevation = ControlsService.SelectedElevation;

            // Don't try to load if elevation is invalid
            if (elevation <= 0 || ControlsService.ElevationIndex < 0 || ControlsService.ElevationIndex >=
            ControlsService.ElevationAngles.Count)
            {
                CurrentValue = null;
                return;
            }

            // Try to get value by lat/lon if provided, otherwise use ray/bin 0,0
            ValueResponse? response = null;
            try
            {
                response = await Http.GetFromJsonAsync<ValueResponse>(
                $"api/RadarData/value-geo/{ControlsService.SelectedChannel}/{Uri.EscapeDataString(timestamp)}/{elevation}/{ControlsService.Latitude}/{ControlsService.Longitude}");
            }
            catch (Exception ex1)
            {
                Logger.LogDebug("Geo lookup failed: {Error}, trying ray/bin fallback", ex1.Message);
                // Fallback to ray/bin if geo lookup fails
                try
                {
                    response = await Http.GetFromJsonAsync<ValueResponse>(
                    $"api/RadarData/value/{ControlsService.SelectedChannel}/{Uri.EscapeDataString(timestamp)}/{elevation}/0/0");
                }
                catch (Exception ex2)
                {
                    Logger.LogWarning("Ray/bin lookup also failed: {Error}", ex2.Message);
                    response = null;
                }
            }

            if (response != null)
            {
                CurrentValue = response.Value;
            }
            else
            {
                CurrentValue = null;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading value");
            CurrentValue = null;
        }
    }

    private async Task OnTimeChanged()
    {
        await LoadElevations();
        await LoadScanMetadata();
        if (ControlsService.SelectedViewType == "Radar")
        {
            await LoadValue();
        }
        await LoadImage();
        StateHasChanged();
    }

    private async Task LoadImage()
    {
        if (Http == null) return;
        try
        {
            if (ControlsService.Timestamps.Count == 0 || ControlsService.ElevationAngles.Count == 0)
            {
                ImageUrl = null;
                return;
            }

            var timestamp = ControlsService.Timestamps[ControlsService.TimeIndex];
            var elevation = ControlsService.SelectedElevation;

            if (elevation <= 0 || ControlsService.ElevationIndex < 0 || ControlsService.ElevationIndex >=
            ControlsService.ElevationAngles.Count)
            {
                ImageUrl = null;
                return;
            }

            // Determine API endpoint based on view type
            string imageUrl;
            if (ControlsService.SelectedViewType == "Raw Data")
            {
                var elevationStr = elevation.ToString(System.Globalization.CultureInfo.InvariantCulture);
                imageUrl =
                $"api/RadarData/raw/{ControlsService.SelectedChannel}/{Uri.EscapeDataString(timestamp)}/{elevationStr}?t={DateTime.Now.Ticks}";
                ImageUrl = imageUrl;
                return;
            }
            else if (ControlsService.SelectedViewType == "Filtered Data")
            {
                var elevationStr = elevation.ToString(System.Globalization.CultureInfo.InvariantCulture);
                imageUrl =
                $"api/RadarData/filtered/{ControlsService.SelectedChannel}/{Uri.EscapeDataString(timestamp)}/{elevationStr}?t={DateTime.Now.Ticks}";
                ImageUrl = imageUrl;
                return;
            }
            else // Radar view
            {
                // Check cache first
                var cachedImage = await ImageCache.GetCachedImageAsync(ControlsService.SelectedChannel, timestamp, elevation);
                if (cachedImage != null)
                {
                    ImageUrl = cachedImage;
                    Logger.LogDebug("Using cached image for {Channel}/{Timestamp}/{Elevation}", ControlsService.SelectedChannel, timestamp,
                    elevation);
                    return;
                }

                // Not in cache, fetch from server
                imageUrl = $"api/RadarData/image/{ControlsService.SelectedChannel}/{Uri.EscapeDataString(timestamp)}/{elevation}";

                try
                {
                    var response = await Http.GetAsync(imageUrl);
                    if (response.IsSuccessStatusCode)
                    {
                        var imageBytes = await response.Content.ReadAsByteArrayAsync();

                        // Store in cache for future use
                        await ImageCache.CacheImageAsync(ControlsService.SelectedChannel, timestamp, elevation, imageBytes);

                        // Convert to data URL for display
                        var base64 = Convert.ToBase64String(imageBytes);
                        ImageUrl = $"data:image/png;base64,{base64}";

                        Logger.LogDebug("Fetched and cached image for {Channel}/{Timestamp}/{Elevation} ({Size} bytes)",
                        ControlsService.SelectedChannel, timestamp, elevation, imageBytes.Length);
                    }
                    else
                    {
                        Logger.LogWarning("Failed to fetch image: {StatusCode}", response.StatusCode);
                        ImageUrl = null;
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error fetching image from server");
                    ImageUrl = null;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading image");
            ImageUrl = null;
        }
    }

    // DTOs
    public class MetadataResponse
    {
        public TimeRangeDto? TimeRange { get; set; }
        public int Count { get; set; }
        public string[] Channels { get; set; } = Array.Empty<string>();
    }

    public class TimeRangeDto
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
    }


    public class ValueResponse
    {
        public float Value { get; set; }
    }

    public void Dispose()
    {
        _isDisposed = true;
        ControlsService.OnStateChanged -= OnControlsChanged;
    }

    public async ValueTask DisposeAsync()
    {
        _isDisposed = true;
        if (_hubConnection is not null)
        {
            try
            {
                await _hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error disposing hub connection");
            }
            _hubConnection = null;
        }
    }
}

<style>
    .radar-viewer-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .viewer-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin: 20px;
    }

    .status-bar {
        padding: 10px 20px;
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
        color: #666;
    }

    .image-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        overflow: auto;
        background-color: #f0f0f0;
    }

    .radar-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .loading-message {
        color: #666;
        font-size: 16px;
        padding: 40px;
    }

    .canvas-placeholder {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #999;
        padding: 40px;
    }

    .canvas-placeholder p {
        margin: 10px 0;
    }

    .hint {
        font-size: 14px;
        font-style: italic;
    }

    .value-display-panel {
        padding: 15px 20px;
        background-color: #e3f2fd;
        border-top: 1px solid #ddd;
        text-align: center;
    }

    .value-text {
        display: block;
        font-size: 24px;
        font-weight: bold;
        color: #1976d2;
        margin-top: 5px;
    }
</style>
